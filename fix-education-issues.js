#!/usr/bin/env node

/**
 * Script de correction des probl√®mes de l'onglet Education
 * et de l'interface admin de gestion de contenu
 */

import { db } from './server/storage.js';
import { 
  contentCategories, 
  educationalContents 
} from './shared/schema.js';
import { eq, and } from 'drizzle-orm';

class EducationFixer {
  constructor() {
    this.storage = db;
  }

  async createDefaultCategories() {
    console.log('üìÅ Cr√©ation des cat√©gories par d√©faut...');
    
    const defaultCategories = [
      {
        id: 'craving_management',
        name: 'üß† Comprendre le Craving',
        description: 'Comprendre et g√©rer les envies compulsives',
        color: 'blue',
        icon: 'brain',
        order: 1,
        isActive: true
      },
      {
        id: 'emergency_strategies',
        name: 'üö® Strat√©gies d\'Urgence',
        description: 'Techniques rapides pour g√©rer les crises',
        color: 'red',
        icon: 'alert-triangle',
        order: 2,
        isActive: true
      },
      {
        id: 'apa_mental_health',
        name: 'üí™ APA et Sant√© Mentale',
        description: 'Activit√© physique adapt√©e pour le bien-√™tre mental',
        color: 'green',
        icon: 'activity',
        order: 3,
        isActive: true
      },
      {
        id: 'breathing_relaxation',
        name: 'ü´Å Respiration & Relaxation',
        description: 'Techniques de respiration et de d√©tente',
        color: 'purple',
        icon: 'wind',
        order: 4,
        isActive: true
      },
      {
        id: 'motivation',
        name: 'üéØ Motivation et Objectifs',
        description: 'Maintenir la motivation dans le parcours de r√©cup√©ration',
        color: 'orange',
        icon: 'target',
        order: 5,
        isActive: true
      }
    ];

    const createdCategories = [];
    
    for (const categoryData of defaultCategories) {
      try {
        // V√©rifier si la cat√©gorie existe d√©j√†
        const existing = await this.storage
          .select()
          .from(contentCategories)
          .where(eq(contentCategories.id, categoryData.id))
          .limit(1);
        
        if (existing.length === 0) {
          const result = await this.storage
            .insert(contentCategories)
            .values(categoryData)
            .returning();
          
          createdCategories.push(result[0]);
          console.log('‚úÖ Cat√©gorie cr√©√©e:', categoryData.name);
        } else {
          // Mettre √† jour si n√©cessaire
          await this.storage
            .update(contentCategories)
            .set({ isActive: true })
            .where(eq(contentCategories.id, categoryData.id));
          
          console.log('üîÑ Cat√©gorie mise √† jour:', categoryData.name);
        }
      } catch (error) {
        console.error('‚ùå Erreur cr√©ation cat√©gorie:', categoryData.name, error.message);
      }
    }
    
    return createdCategories;
  }

  async createSampleContent() {
    console.log('üìö Cr√©ation de contenu √©ducationnel de d√©monstration...');
    
    const sampleContents = [
      {
        title: 'Comprendre le m√©canisme du craving',
        categoryId: 'craving_management',
        type: 'text',
        difficulty: 'easy',
        content: `# Le m√©canisme du craving

Le craving, ou envie compulsive, est une exp√©rience neurobiologique complexe qui implique plusieurs circuits c√©r√©braux.

## Qu'est-ce que le craving ?

Le craving se caract√©rise par :
- Une envie intense et soudaine
- Des pens√©es obs√©dantes
- Une sensation d'urgence
- Une difficult√© √† se concentrer sur autre chose

## Les d√©clencheurs

Les principaux d√©clencheurs incluent :
- **Environnementaux** : lieux, personnes, objets
- **√âmotionnels** : stress, ennui, tristesse
- **Physiques** : fatigue, faim, douleur
- **Sociaux** : pressions, situations sociales

## La r√©ponse neurobiologique

Quand un d√©clencheur active le circuit de r√©compense :
1. Lib√©ration de dopamine dans le cerveau
2. Activation du syst√®me de motivation
3. Focalisation de l'attention sur l'objet du craving
4. Diminution des capacit√©s de contr√¥le inhibiteur

## Points cl√©s √† retenir

- Le craving est temporaire et diminue naturellement
- Comprendre ses d√©clencheurs permet de mieux les anticiper
- Des techniques sp√©cifiques peuvent aider √† g√©rer l'intensit√©`,
        description: 'Introduction aux m√©canismes neurobiologiques du craving',
        estimatedReadTime: 8,
        status: 'published',
        isRecommended: true,
        authorId: 'system'
      },
      {
        title: 'Technique STOP en situation de crise',
        categoryId: 'emergency_strategies',
        type: 'text',
        difficulty: 'easy',
        content: `# La technique STOP

Une m√©thode simple et efficace pour g√©rer les moments de crise intense.

## Les 4 √©tapes de STOP

### S - STOP (Arr√™tez-vous)
- Interrompez imm√©diatement ce que vous faites
- Prenez une pause physique et mentale
- Posez-vous et restez immobile quelques secondes

### T - TAKE A BREATH (Respirez)
- Prenez 3 respirations profondes et lentes
- Inspirez par le nez (4 secondes)
- Retenez votre souffle (4 secondes)
- Expirez par la bouche (6 secondes)

### O - OBSERVE (Observez)
- Que se passe-t-il dans votre corps ?
- Quelles √©motions ressentez-vous ?
- Quelles pens√©es traversent votre esprit ?
- O√π vous trouvez-vous ? Qui est pr√©sent ?

### P - PROCEED (Continuez en pleine conscience)
- Choisissez consciemment votre prochaine action
- Utilisez une strat√©gie de coping appropri√©e
- Agissez en fonction de vos valeurs, pas de l'impulsion

## Quand utiliser STOP ?

- Sensation de craving intense
- Mont√©e d'√©motions difficiles
- Pens√©es obs√©dantes
- Envie d'agir impulsivement
- Moments de stress aigu

## Conseil pratique

Entra√Ænez-vous √† utiliser STOP dans des situations moins intenses pour que cette technique devienne automatique.`,
        description: 'M√©thode rapide pour g√©rer les crises et reprendre le contr√¥le',
        estimatedReadTime: 5,
        status: 'published',
        isRecommended: true,
        authorId: 'system'
      },
      {
        title: 'Les bienfaits de l\'exercice sur l\'humeur',
        categoryId: 'apa_mental_health',
        type: 'text',
        difficulty: 'intermediate',
        content: `# L'exercice physique : un antid√©presseur naturel

L'activit√© physique r√©guli√®re est l'un des outils les plus puissants pour am√©liorer l'humeur et r√©duire les sympt√¥mes de d√©pression et d'anxi√©t√©.

## Les m√©canismes d'action

### Neurochimiques
- **Endorphines** : "hormones du bonheur" lib√©r√©es pendant l'effort
- **BDNF** : facteur neurotrophique qui favorise la neuroplasticit√©
- **Neurotransmetteurs** : augmentation de la s√©rotonine, dopamine et noradr√©naline

### Psychologiques
- Am√©lioration de l'estime de soi
- Sentiment d'accomplissement
- Distraction des pens√©es n√©gatives
- Augmentation de la confiance en soi

### Sociaux
- Opportunit√©s de socialisation
- Soutien du groupe ou coach
- Sentiment d'appartenance

## Types d'exercices b√©n√©fiques

### Exercices cardiovasculaires (30-45 min)
- Course √† pied ou marche rapide
- Natation
- Cyclisme
- Danse

### Exercices de force (20-30 min)
- Musculation
- Exercices au poids du corps
- Yoga dynamique
- Pilates

### Activit√©s douces (15-60 min)
- Marche contemplative
- Tai chi
- Yoga relaxant
- √âtirements

## Recommandations pratiques

- **Fr√©quence** : Au moins 3-4 fois par semaine
- **Dur√©e** : 20-60 minutes selon l'activit√©
- **Intensit√©** : Mod√©r√©e (vous devez pouvoir tenir une conversation)
- **R√©gularit√©** : Plus important que l'intensit√©

## Conseils pour d√©buter

1. Commencez petit (10-15 minutes)
2. Choisissez une activit√© que vous aimez
3. Planifiez des cr√©neaux fixes
4. Trouvez un partenaire d'entra√Ænement
5. C√©l√©brez vos progr√®s`,
        description: 'Comment l\'activit√© physique am√©liore naturellement l\'humeur',
        estimatedReadTime: 12,
        status: 'published',
        isRecommended: false,
        authorId: 'system'
      },
      {
        title: 'Respiration 4-7-8 pour l\'anxi√©t√©',
        categoryId: 'breathing_relaxation',
        type: 'text',
        difficulty: 'easy',
        content: `# La technique de respiration 4-7-8

Une m√©thode simple et scientifiquement prouv√©e pour r√©duire rapidement l'anxi√©t√© et favoriser la relaxation.

## Principe de base

Cette technique active le syst√®me nerveux parasympathique, responsable de la r√©ponse de relaxation du corps.

## Comment pratiquer ?

### Position
- Asseyez-vous confortablement, dos droit
- Ou allongez-vous sur le dos
- Placez une main sur la poitrine, une sur le ventre

### La s√©quence 4-7-8

1. **Inspirez par le nez** pendant **4 secondes**
   - Le ventre doit se gonfler, pas la poitrine
   
2. **Retenez votre souffle** pendant **7 secondes**
   - Comptez mentalement et restez d√©tendu
   
3. **Expirez par la bouche** pendant **8 secondes**
   - Videz compl√®tement vos poumons
   - Faites un l√©ger bruit en expirant

### R√©p√©tition
- Commencez par 4 cycles complets
- Augmentez progressivement jusqu'√† 8 cycles
- Pratiquez 2-3 fois par jour

## B√©n√©fices observ√©s

### Imm√©diats (apr√®s 2-3 minutes)
- R√©duction de la fr√©quence cardiaque
- Diminution de la tension musculaire
- Calme mental

### √Ä long terme (apr√®s quelques semaines)
- Meilleure gestion du stress
- Am√©lioration du sommeil
- R√©duction de l'anxi√©t√© g√©n√©rale

## Quand utiliser cette technique ?

- Avant de s'endormir
- En p√©riode de stress
- Lors d'attaques d'anxi√©t√©
- Avant un √©v√©nement stressant
- Pour se recentrer pendant la journ√©e

## Conseils pratiques

- Ne forcez jamais le rythme
- Si vous ressentez un vertige, ralentissez
- La pratique r√©guli√®re am√©liore l'efficacit√©
- Combinez avec la m√©ditation pour plus de b√©n√©fices`,
        description: 'Technique de respiration simple pour calmer l\'anxi√©t√© rapidement',
        estimatedReadTime: 6,
        status: 'published',
        isRecommended: true,
        authorId: 'system'
      }
    ];

    const createdContents = [];
    
    for (const contentData of sampleContents) {
      try {
        // V√©rifier si le contenu existe d√©j√†
        const existing = await this.storage
          .select()
          .from(educationalContents)
          .where(and(
            eq(educationalContents.title, contentData.title),
            eq(educationalContents.authorId, 'system')
          ))
          .limit(1);
        
        if (existing.length === 0) {
          const result = await this.storage
            .insert(educationalContents)
            .values({
              ...contentData,
              createdAt: new Date(),
              updatedAt: new Date()
            })
            .returning();
          
          createdContents.push(result[0]);
          console.log('‚úÖ Contenu cr√©√©:', contentData.title);
        } else {
          console.log('‚è≠Ô∏è Contenu existe d√©j√†:', contentData.title);
        }
      } catch (error) {
        console.error('‚ùå Erreur cr√©ation contenu:', contentData.title, error.message);
      }
    }
    
    return createdContents;
  }

  async publishDraftContents() {
    console.log('üì¢ Publication des contenus en brouillon...');
    
    try {
      const draftContents = await this.storage
        .select()
        .from(educationalContents)
        .where(eq(educationalContents.status, 'draft'));
      
      console.log(`üìã ${draftContents.length} contenus en brouillon trouv√©s`);
      
      if (draftContents.length > 0) {
        await this.storage
          .update(educationalContents)
          .set({ 
            status: 'published',
            publishedAt: new Date(),
            updatedAt: new Date()
          })
          .where(eq(educationalContents.status, 'draft'));
        
        console.log(`‚úÖ ${draftContents.length} contenus publi√©s`);
      }
      
      return draftContents.length;
    } catch (error) {
      console.error('‚ùå Erreur publication contenus:', error.message);
      return 0;
    }
  }

  async fixCategoryReferences() {
    console.log('üîß Correction des r√©f√©rences de cat√©gories...');
    
    try {
      const contents = await this.storage
        .select()
        .from(educationalContents);
      
      let fixed = 0;
      
      for (const content of contents) {
        let needsUpdate = false;
        const updates = {};
        
        // Si categoryId est manquant mais category existe
        if (!content.categoryId && content.category) {
          updates.categoryId = content.category;
          needsUpdate = true;
        }
        
        // Si categoryId existe mais pas reconnu, utiliser une cat√©gorie par d√©faut
        if (content.categoryId) {
          const validCategories = [
            'craving_management', 'emergency_strategies', 'apa_mental_health', 
            'breathing_relaxation', 'motivation'
          ];
          
          if (!validCategories.includes(content.categoryId)) {
            updates.categoryId = 'craving_management'; // Cat√©gorie par d√©faut
            needsUpdate = true;
          }
        }
        
        if (needsUpdate) {
          await this.storage
            .update(educationalContents)
            .set({ ...updates, updatedAt: new Date() })
            .where(eq(educationalContents.id, content.id));
          
          fixed++;
        }
      }
      
      console.log(`üîß ${fixed} contenus corrig√©s`);
      return fixed;
    } catch (error) {
      console.error('‚ùå Erreur correction r√©f√©rences:', error.message);
      return 0;
    }
  }

  async runFullFix() {
    console.log('üîß === CORRECTION DES PROBL√àMES EDUCATION ===\n');
    
    try {
      // 1. Cr√©er les cat√©gories par d√©faut
      console.log('üìÅ √âtape 1: Cr√©ation des cat√©gories...');
      await this.createDefaultCategories();
      
      // 2. Corriger les r√©f√©rences de cat√©gories existantes
      console.log('\nüîß √âtape 2: Correction des r√©f√©rences...');
      await this.fixCategoryReferences();
      
      // 3. Publier les contenus en brouillon
      console.log('\nüì¢ √âtape 3: Publication des brouillons...');
      const publishedCount = await this.publishDraftContents();
      
      // 4. Cr√©er du contenu de d√©monstration si n√©cessaire
      console.log('\nüìö √âtape 4: Cr√©ation de contenu de d√©monstration...');
      const publishedContents = await this.storage
        .select()
        .from(educationalContents)
        .where(eq(educationalContents.status, 'published'));
      
      if (publishedContents.length === 0) {
        await this.createSampleContent();
      } else {
        console.log(`‚è≠Ô∏è ${publishedContents.length} contenus publi√©s d√©j√† pr√©sents`);
      }
      
      // 5. V√©rification finale
      console.log('\n‚úÖ √âtape 5: V√©rification finale...');
      const finalCategories = await this.storage
        .select()
        .from(contentCategories)
        .where(eq(contentCategories.isActive, true));
      
      const finalContents = await this.storage
        .select()
        .from(educationalContents)
        .where(eq(educationalContents.status, 'published'));
      
      console.log(`üìä R√©sultat final:`);
      console.log(`   - ${finalCategories.length} cat√©gories actives`);
      console.log(`   - ${finalContents.length} contenus publi√©s`);
      
      if (finalCategories.length > 0 && finalContents.length > 0) {
        console.log('\nüéâ SUCC√àS : Les probl√®mes ont √©t√© corrig√©s !');
        console.log('   - L\'onglet Education devrait maintenant se charger');
        console.log('   - L\'interface admin devrait afficher les contenus');
        console.log('   - Les utilisateurs peuvent voir le contenu √©ducationnel');
      } else {
        console.log('\n‚ö†Ô∏è Des probl√®mes persistent. V√©rification manuelle requise.');
      }
      
    } catch (error) {
      console.error('‚ùå Erreur lors de la correction:', error.message);
      throw error;
    }
  }
}

// Ex√©cution de la correction
const fixer = new EducationFixer();
fixer.runFullFix()
  .then(() => {
    console.log('\n‚úÖ Script de correction termin√©');
    process.exit(0);
  })
  .catch(error => {
    console.error('\n‚ùå Erreur fatale:', error);
    process.exit(1);
  });